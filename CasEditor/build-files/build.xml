<?xml version="1.0" encoding="UTF-8"?>

<!--
		Licensed to the Apache Software Foundation (ASF) under one
		or more contributor license agreements.  See the NOTICE file
		distributed with this work for additional information
		regarding copyright ownership.  The ASF licenses this file
		to you under the Apache License, Version 2.0 (the
		"License"); you may not use this file except in compliance
		with the License.  You may obtain a copy of the License at
		
		http://www.apache.org/licenses/LICENSE-2.0
		
		Unless required by applicable law or agreed to in writing,
		software distributed under the License is distributed on an
		"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
		KIND, either express or implied.  See the License for the
		specific language governing permissions and limitations
		under the License.    
	-->

<project name="org.apache.uima.caseditor" default="build" basedir=".">

	<!-- user build properties-->
	<property file="build_local.properties" />
	<!-- general build properties-->
	<property file="build.properties" />
	
	<fail message="The eclipseLocation property must be set in the build_local.properties file." 
		unless="eclipseLocation" />
	
	<fail message="The outputLocation property must be set in the build_local.properties file." 
		unless="outputLocation" />
	
	<!-- build directory == user specified outputLocation -->
	<property name="buildDirectory" location="${outputLocation}" />
	<property name="base" location="${outputLocation}/base" />
	
	<!-- set "buildFile" property to eclipse productBuild.xml -->
	<fileset dir="${eclipseLocation}/plugins" 
		     includes="org.eclipse.pde.build_*/scripts/productBuild/productBuild.xml" 
		     id="pde.plugin.path" />	
	<pathconvert property="buildfile" refid="pde.plugin.path" setonempty="false"/>
	<fail message="Unable to find productBuild.xml." unless="buildfile" />

	<!-- set "equinox" property to eclipse launcher -->
	<fileset dir="${eclipseLocation}/plugins" 
		     includes="org.eclipse.equinox.launcher_*.jar" 
		     id="equinox.plugin.path" />
	<pathconvert property="equinox" refid="equinox.plugin.path" setonempty="false"/>
	<fail message="Unable to find equinox." 
		unless="equinox" />
	
	<!-- prepare the build directory with the uima runtime plugin and
	     with the CasEditor sources -->
	<target name="prepareBuildDirectory">

		<mkdir dir="${buildDirectory}/plugins" />
		<mkdir dir="${buildDirectory}/features" />
		
		<copy todir="${buildDirectory}/plugins/org.apache.uima.caseditor">
			<fileset dir="../">
				<exclude name="**/target/**"/>
			</fileset>
		</copy>
	</target>

	<target name="build" depends="prepareBuildDirectory">
		<java classname="org.eclipse.core.launcher.Main" fork="true" failonerror="true">
			<arg value="-application" />
			<arg value="org.eclipse.ant.core.antRunner" />
			<arg value="-buildfile" />
			<arg value="${buildfile}" />
			<jvmarg value="-DbuildDirectory=${buildDirectory}"/>
			<jvmarg value="-Dbase=${base}"/>
			<jvmarg value="-DbaseLocation=${eclipseLocation}"/>
			<classpath>
				<pathelement path="${equinox}" />
			</classpath>
		</java>
		
	<!-- ***** Create source distribution *****-->
	<mkdir dir="${outputLocation}/${buildLabel}/${buildId}-src" />

	<!-- Copy CasEditor sources -->
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-src/CasEditor">
		<fileset dir="../">
			<exclude name="**/target/**"/>
			<exclude name="**/build_local.properties"/>
		</fileset>
	</copy>
	<!-- Copy uima-docbook-tool sources -->
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-src/uima-docbook-tool">
		<fileset dir="../../uima-docbook-tool">
			<exclude name="**/tools/**"/>
		</fileset>
		<fileset dir="../../uima-docbook-tool/">
			<include name="**/tools/common-lib/**"/>
			<include name="**/tools/fop-versions/**"/>
		</fileset>
	</copy>	
	<!-- Copy SandboxDocs sources -->	
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-src/SandboxDocs">
		<fileset dir="../../SandboxDocs"/>
	</copy>
	<!-- Copy CasEditor LICENSE, README, NOTICE files to toplevel dir of source disstribution -->
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-src">
		<fileset dir="${outputLocation}/plugins/org.apache.uima.caseditor/src/main/readme">
		</fileset>
	</copy>
	<!-- create zip file for source distribution -->	
	<zip destfile="${outputLocation}/${buildLabel}/${archivePrefix}-src-${buildId}.zip">
		<zipfileset dir="${outputLocation}/${buildLabel}/${buildId}-src" prefix="${buildId}-src"/>
	</zip>
	<!-- clean soruce distribution build -->
	<delete dir="${outputLocation}/${buildLabel}/${buildId}-src"/>

	<!-- ***** build CasEditor documentation *****-->
	<ant antfile="build_documentation.xml" dir=".." inheritall="true"/>
		
	<!-- ***** update win32 build *****-->
	<unzip src="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86.zip" 
   		   dest="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86"/>		
	<delete file="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86.zip"/>
	
	<!-- Inject LICENSE, NOTICE and DISCLAIMER files into win32 build -->
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86/CasEditor">
		<fileset dir="${outputLocation}/plugins/org.apache.uima.caseditor/src/main/readme">
		</fileset>
	</copy>
	
	<!-- copy over docs to win32 build-->
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86/CasEditor/docs/html">
		<fileset dir="../target">
			<include name="**/casEditorUserGuide/**"/>
			<include name="**/images/**"/>
			<exclude name="**/casEditorUserGuide/casEditorUserGuide.pdf*"/>
		</fileset>
	</copy>
	<copy file="../target/casEditorUserGuide/casEditorUserGuide.pdf"  
			todir="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86/CasEditor/docs/pdf"/>	
	
	<!-- Inject MANIFEST.MF, NOTICE, LICENSE, DISCLAIMER into caseditor plugin and caseditor.jar file -->
	<copy todir="${outputLocation}/${buildLabel}/manifest-temp/META-INF">
			<fileset dir="${outputLocation}/plugins/org.apache.uima.caseditor/src/main/readme">
				<include name="NOTICE"/>
				<include name="LICENSE"/>
				<include name="DISCLAIMER"/>
			</fileset>
	</copy>
	<jar destfile="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86/CasEditor/plugins/org.apache.uima.caseditor_${buildVersion}.incubating/caseditor.jar"
		manifest="../src/main/manifest/MANIFEST.MF" update="true"
		basedir="${outputLocation}/${buildLabel}/manifest-temp/"
		includes="**">
	</jar>
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86/CasEditor/plugins/org.apache.uima.caseditor_${buildVersion}.incubating/META-INF">
		<fileset dir="${outputLocation}/${buildLabel}/manifest-temp/META-INF"/>
	</copy>
	<delete dir="${outputLocation}/${buildLabel}/manifest-temp/"/>
		
	<!-- create win32 build zip-->
	<zip destfile="${outputLocation}/${buildLabel}/${archivePrefix}-win32.win32.x86-${buildId}.zip"
		       basedir="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86"/>
	<!-- cleanup build directory-->
	<delete dir="${outputLocation}/${buildLabel}/${buildId}-win32.win32.x86"/>
	
	<!-- ***** update linux build *****-->
	<unzip src="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86.zip" 
    	   dest="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86"/>
	<delete file="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86.zip"/>
		
	<!-- Inject LICENSE, NOTICE and DISCLAIMER files into linux build -->
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86/CasEditor">
		<fileset dir="${outputLocation}/plugins/org.apache.uima.caseditor/src/main/readme">
		</fileset>
	</copy>
	
	<!-- copy over docs to linux build-->
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86/CasEditor/docs/html">
		<fileset dir="../target">
			<include name="**/casEditorUserGuide/**"/>
			<include name="**/images/**"/>
			<exclude name="**/casEditorUserGuide/casEditorUserGuide.pdf*"/>
		</fileset>
	</copy>
	<copy file="../target/casEditorUserGuide/casEditorUserGuide.pdf"  
		  todir="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86/CasEditor/docs/pdf"/>

	<!-- Inject MANIFEST.MF, NOTICE, LICENSE, DISCLAIMER into caseditor plugin and caseditor.jar file -->
	<copy todir="${outputLocation}/${buildLabel}/manifest-temp/META-INF">
			<fileset dir="${outputLocation}/plugins/org.apache.uima.caseditor/src/main/readme">
				<include name="NOTICE"/>
				<include name="LICENSE"/>
				<include name="DISCLAIMER"/>
			</fileset>
	</copy>
	<jar destfile="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86/CasEditor/plugins/org.apache.uima.caseditor_${buildVersion}.incubating/caseditor.jar"
		manifest="../src/main/manifest/MANIFEST.MF" update="true"
		basedir="${outputLocation}/${buildLabel}/manifest-temp/"
		includes="**">
	</jar>
	<copy todir="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86/CasEditor/plugins/org.apache.uima.caseditor_${buildVersion}.incubating/META-INF">
		<fileset dir="${outputLocation}/${buildLabel}/manifest-temp/META-INF"/>
	</copy>
	<delete dir="${outputLocation}/${buildLabel}/manifest-temp/"/>
		
	<!-- create linux zip -->		
	<zip destfile="${outputLocation}/${buildLabel}/${archivePrefix}-linux.gtk.x86-${buildId}.zip"
		       basedir="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86"/>

	<!-- create linux tar.gz -->		
	<tar tarfile="${outputLocation}/${buildLabel}/${archivePrefix}-linux.gtk.x86-${buildId}.tar" 
		 basedir="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86"/>
	<gzip src="${outputLocation}/${buildLabel}/${archivePrefix}-linux.gtk.x86-${buildId}.tar" 
		  destfile="${outputLocation}/${buildLabel}/${archivePrefix}-linux.gtk.x86-${buildId}.tar.gz"/>
	<delete file="${outputLocation}/${buildLabel}/${archivePrefix}-linux.gtk.x86-${buildId}.tar"/>

	<!-- cleanup build directory-->		
	<delete dir="${outputLocation}/${buildLabel}/${buildId}-linux.gtk.x86"/>
		
	</target>
</project>